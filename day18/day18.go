package main

import (
	"fmt"
	"strings"
)

func step(s []string) ([]string, bool) {
	changed := false
	var rows []string
	h := len(s)
	w := len(s[0])
	get := func(i, j int) byte {
		if i < 0 || i >= w {
			return 0
		}
		if j < 0 || j >= h {
			return 0
		}
		return s[j][i]
	}
	for j := 0; j < h; j++ {
		var b strings.Builder
		for i := 0; i < w; i++ {
			c := get(i, j)
			t := 0
			l := 0
			for ii := i - 1; ii <= i+1; ii++ {
				for jj := j - 1; jj <= j+1; jj++ {
					if ii == i && jj == j {
						continue
					}
					switch get(ii, jj) {
					case '|':
						t++
					case '#':
						l++
					}
				}
			}
			if c == '.' {
				if t >= 3 {
					b.WriteByte('|')
					changed = true
				} else {
					b.WriteByte('.')
				}
			} else if c == '|' {
				if l >= 3 {
					b.WriteByte('#')
					changed = true
				} else {
					b.WriteByte('|')
				}
			} else if c == '#' {
				if l >= 1 && t >= 1 {
					b.WriteByte('#')
				} else {
					b.WriteByte('.')
					changed = true
				}
			}
		}
		rows = append(rows, b.String())
	}
	return rows, changed
}

func hash(s []string) string {
	return strings.Join(s, "\n")
}

func main() {
	for part := 1; part <= 2; part++ {
		got := strings.Split(input, "\n")
		iters := 10
		if part == 2 {
			iters = 1000000000
		}
		found := map[string]int{}
		fast := false
		for i := 0; i < iters; i++ {
			key := hash(got)
			if n0, ok := found[key]; !fast && ok {
				fmt.Printf("found repeat: %d and %d\n", n0, i)
				fmt.Println(key)
				step := i - n0
				for i+step < iters {
					i += step
				}
				fast = true
			}
			if !fast {
				found[key] = i
			}
			if false {
				fmt.Println("After", i, "minutes:")
				for _, row := range got {
					fmt.Println(row)
				}
				fmt.Println()
			}
			var changed bool
			got, changed = step(got)
			if !changed {
				break
			}
		}
		t, l := 0, 0
		for _, row := range got {
			for _, b := range row {
				if b == '|' {
					t++
				} else if b == '#' {
					l++
				}
			}
		}
		fmt.Println(t * l)
	}
}

var input = `.||....##....|#|#.....|||...|............|......#.
#....|#|..#....#....|...#.||...||..|||#|..#..|.##.
.#|##|.#.|#|..|||....#|..|....|.##.#||#.|.#|..|..|
|...|#.|...#..|...|#.|.#...##....|.||#...|...|...#
.....|..#||..........###...#.||.###.|..#|#||..|#..
|||.|##...|.|||#......###....|#.#|...|.#..|.|.|##.
.......|.####.||##|.##....#............||#..#..|..
..#|.|....#..|...|||..|...............|.|#..|.||#.
.||#.#||.|.|.#.#|....#.#|..|.|#|.|.....|.#...|#..#
......#..|...#....||#.#.#|..#...#.|||||..|#....|#|
#.#|..#|#||#|||..#...#.........|.|..#...|......|.#
|....|#..|##.....|...||.#....#......#...|..|#|#..#
.|##.|...|......##.##.........#.#..|.||........|..
.#||#.#...|.|.|.#|.#..|.|#..|##.|..|#....##.||....
...|..|.#........#.|###|.#|...||.#....|..#.....#|.
........#.###..###.....#....#|#|...#||..|..|....#|
.|...........||.|...#|..|#....#|.#..|#..|..|.|.|..
#.#..|.|||....|.....#|#...##.#......|..|..#..#.#|#
.#|.#.........|.....##|##.#.#...#|...........#|#..
..##|.|.|.##|.##..|..|...#|#..|.....|.|.#...#...||
.|||..#.#.|.|#......####.........#|.|.#|.|.|.#.|..
|#...|.........#.##..|....|....#|...||.#.|...|#.|#
##.|.#..|#|#|#.|#.|##|..#.|..##.#....##.#...#|.|..
.||#..#.#....|.#.#..#|.|.#|##|#.#||....#....#...|.
#...#...|.|||.....#.|.#|..#......#.#...#.#|...|#||
...##...|.#.##..||..#|.....|....#.##.#.|..|.|#.#.|
..#..|...#.|..#......||....#.#|..##|.#....#.|.|...
||.....|..|##.....##......#|.......|##.|.#.|.#.|..
#|.|...|.|#...|...........#......|......|...#|.#..
#|###|..#.##.||..#....|####.#.......#|..|...|.....
........#.|.........#..##.#.#...|.#.....|.|.#.#|#.
.##.##.#.|#|..#.###|...#....|#.|#.#|#....#.|...|..
||...#......|||..#.|.||.|.|#..........#...#.|.|..#
|.....|..|....#|.#|.#...|#..|#|#..#.###.|.....#.#.
..#...|#..#...|||..###.|#.|..|......|.||....#.....
.##.#||..#....#.#.|..|.....#...|..#.|....#..##..||
........#..............#.||.#........|.|...|.|....
..#.#..##..|.|..|#....||#...|.#...#|..|##..|...##|
......#|##..#..........#...||.#|.||.|..|..|....|.#
##..|.##|..#|#|#.|....|.#|..|#.#...#..##|#.##|.|..
|...#.|.#.#..|..|....|#||...#..#....#..#|.......#.
....#.###.#.|.....#.|.#.#.#...|.#|#...#|.....|.##.
#......#..#.|.....||.#..|....|...#|||....|..|#.|..
..|.#|##...#.#..#|...|........||#.#.#||.|#.#|#...|
...|.|.#...|.|.....###|#.##|.#.....#|..|#|#|#.|#|.
.##..|#.#..#....|#....|..|.||.#|..|.|.|.|..#.#.|..
.#..|.|##||...|......|...#..#|.#....#...#|||...||.
.|#.#....|#.#|.|....||.||.##|#...#.||.#.......#|..
#...||.....|.|...|||...||....#..#....||.|#.|...|#.
...|#..||....|#..|....|...|.||#..||..#.|..##......`

var ex = `.#.#...|#.
.....#|##|
.|..|...#.
..|#.....#
#.#|||#|#|
...#.||...
.|....|...
||...#|.#|
|.||||..|.
...#.|..|.`
